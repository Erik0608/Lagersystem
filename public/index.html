<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lagerverwaltung (Beispiel)</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
    form { display:flex; gap:.5rem; margin-bottom:1rem; }
    input[type="text"] { flex:1; padding:.5rem; }
    input[type="number"] { width:5.5rem; padding:.5rem; }
    button { padding:.5rem 1rem; }
    table { width:100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border:1px solid #ddd; padding:.5rem; text-align:left; }
    th { background:#f4f4f4; }
    .msg { margin-top:.5rem; color: #007700; }
    .error { color: #aa0000; }
  </style>
</head>
<body>
  <h1>Lagerverwaltung — Beispiel</h1>

  <form id="addForm">
    <input type="text" id="name" placeholder="Name des Gegenstandes" required />
    <input type="number" id="quantity" placeholder="Anzahl" min="1" value="1" required />
    <button type="submit">Hinzufügen</button>
  </form>

  <div id="feedback" role="status"></div>

  <section>
    <h2>Alle Gegenstände</h2>
    <div id="listWrap">
      <table id="itemsTable" aria-live="polite">
        <thead>
          <tr><th>ID</th><th>Name</th><th>Anzahl</th><th>Erfasst</th></tr>
        </thead>
        <tbody id="itemsBody">
          <!-- Einträge werden hier eingefügt -->
        </tbody>
      </table>
    </div>
  </section>

  <script>
    async function fetchItems() {
      try {
        const res = await fetch('/items');
        if (!res.ok) throw new Error('Fehler beim Laden');
        const items = await res.json();
        const tbody = document.getElementById('itemsBody');
        tbody.innerHTML = '';
        if (!items.length) {
          tbody.innerHTML = '<tr><td colspan="4">Keine Einträge</td></tr>';
          return;
        }
        for (const it of items) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHTML(it.id)}</td>
            <td>${escapeHTML(it.name)}</td>
            <td>${escapeHTML(it.quantity)}</td>
            <td>${escapeHTML(new Date(it.created_at).toLocaleString())}</td>
          `;
          tbody.appendChild(tr);
        }
      } catch (err) {
        console.error(err);
        document.getElementById('feedback').textContent = 'Konnte Einträge nicht laden.';
        document.getElementById('feedback').className = 'error';
      }
    }

    function escapeHTML(s) {
      if (s === null || s === undefined) return '';
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    document.getElementById('addForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const quantity = parseInt(document.getElementById('quantity').value, 10) || 1;
      const fb = document.getElementById('feedback');

      if (!name) {
        fb.textContent = 'Name darf nicht leer sein.';
        fb.className = 'error';
        return;
      }

      try {
        const res = await fetch('/items', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, quantity })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          fb.textContent = err.error || 'Fehler beim Hinzufügen';
          fb.className = 'error';
          return;
        }

        const newItem = await res.json();
        fb.textContent = `Hinzugefügt: ${newItem.name} (ID ${newItem.id})`;
        fb.className = 'msg';
        document.getElementById('name').value = '';
        document.getElementById('quantity').value = '1';
        fetchItems();
      } catch (err) {
        console.error(err);
        fb.textContent = 'Netzwerkfehler beim Hinzufügen.';
        fb.className = 'error';
      }
    });

    // initial laden
    fetchItems();
  </script>
</body>
</html>